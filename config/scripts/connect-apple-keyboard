#!/usr/bin/env bash

set -euo pipefail

MAC="1C:1D:D3:74:6C:A9"      # address
NAME="Apple magic keyboard"  # name
TRIES="${1:-3}"              # retries (default 20)
SLEEP="${2:-3}"              # seconds between tries

if bluetoothctl info "$MAC" | grep -q 'Connected: yes'; then
  notify-send "$NAME already connected"
  exit 0
fi

# make adapter ready
bluetoothctl power on >/dev/null || true
bluetoothctl agent on >/dev/null || true
bluetoothctl default-agent >/dev/null || true
bluetoothctl trust "$MAC" >/dev/null || true

i=0
while [ "$i" -lt "$TRIES" ]; do
  i=$((i+1))
  if bluetoothctl connect "$MAC" | grep -q 'Connection successful'; then
    notify-send "$NAME connected."
    break
  fi

  # if adapter got wonky, nudge it
  if ! bluetoothctl show | grep -q 'Powered: yes'; then
    rfkill unblock bluetooth || true
    bluetoothctl power on || true
  fi

  sleep "$SLEEP"
done

if ! bluetoothctl info "$MAC" | grep -q 'Connected: yes'; then
  notify-send "failed to connect. The headset likely has 2 other hosts attached."
  exit 1
fi

notify-send "Connected"