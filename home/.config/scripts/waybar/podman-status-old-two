#!/usr/bin/env bash

ICON="ó°¡¨"

command -v jq >/dev/null 2>&1 || exit 0
command -v systemctl >/dev/null 2>&1 || {
  jq -nc --arg icon "$ICON" '{
    "text": ($icon + " off"),
    "tooltip": "systemd not available",
    "class": "off"
  }'
  exit 0
}

count_running() {
  scope="$1" # "" or "--user"
  systemctl $scope list-units --type=service --state=running --no-legend --no-pager 2>/dev/null \
    | awk '{print $1}' \
    | grep -E '^(podman-|docker-)' \
    | wc -l
}

count_any() {
  scope="$1" # "" or "--user"
  systemctl $scope list-unit-files --type=service --no-legend --no-pager 2>/dev/null \
    | awk '{print $1}' \
    | grep -E '^(podman-|docker-)' \
    | wc -l
}

user_running=$(count_running --user)
system_running=$(count_running)

user_any=$(count_any --user)
system_any=$(count_any)

running=$((user_running + system_running))
has_any=$((user_any + system_any))

if [ "$has_any" -eq 0 ]; then
  jq -nc --arg icon "$ICON" '{
    "text": ($icon + " off"),
    "tooltip": "no podman-/docker- services found",
    "class": "off"
  }'
  exit 0
fi

if [ "$running" -eq 0 ]; then
  cls="idle"
  tooltip="podman-/docker- services present, none running"
else
  cls="active"
  tooltip="running services: user='"$user_running"', system='"$system_running"'"
fi

jq -nc \
  --arg icon "$ICON" \
  --arg running "$running" \
  --arg tooltip "$tooltip" \
  --arg cls "$cls" \
  '{
    "text": ($icon + " " + $running),
    "tooltip": $tooltip,
    "class": $cls
  }'

