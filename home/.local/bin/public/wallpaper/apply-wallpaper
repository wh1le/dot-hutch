#!/usr/bin/env bash

set -e

WALLPAPERS_PATH=~/dot/wallpapers/default-collection
CURRENT_WALLPAPER="$HOME/.current_wallpaper"

CHOICE="${1:-$CURRENT_WALLPAPER}"

echo "$CHOICE"

if [[ ! -e "$CHOICE" ]]; then
  echo "No wallpaper set yet! Pick something fancy: $(basename "$0") /path/to/image"
  exit 0
fi

MONITORS=$(hyprctl monitors -j | jq -r '.[] | select(.description | contains("Paperlike") | not) | "\(.name):\(.transform)"')

for entry in $MONITORS; do
  monitor="${entry%:*}"
  transform="${entry#*:}"

  resize_flag=""

  [[ "$transform" -eq 1 ]] && resize_flag="--resize fit"

  swww img \
    --outputs "$monitor" \
    --transition-type random \
    --transition-angle 45 \
    --resize fit \
    --transition-duration 1 "$CHOICE"
done

if [[ "$CHOICE" != "$CURRENT_WALLPAPER" ]]; then
  ln -s -f "$CHOICE" "$CURRENT_WALLPAPER"
fi

wal -esnti "$CHOICE"

$HOME/.local/bin/public/wallpaper/apply-wallpaper-eink
$HOME/.local/bin/public/wallpaper/apply-colors-globally
