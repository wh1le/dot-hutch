#!/usr/bin/env bash
# set -euo pipefail
# based on script of https://github.com/BreadOnPenguins/scripts/blob/master/wallpapermenu

WALLPAPERS_PATH=~/dot/wallpapers

pkill nsxiv || true

apply-wallpaper() {
  CHOICE="$1"

  MONITORS=$(hyprctl monitors -j | jq -r '.[] | select(.description | contains("Paperlike") | not) | .name')

  for monitor in $MONITORS; do
    swww img \
      --outputs "$monitor" \
      --transition-type random \
      --transition-angle 45 \
      --resize fit \
      --transition-duration 0.8 "$CHOICE"
  done

  ln -s -f "$CHOICE" ~/.current_wallpaper
  wal -esnti "$CHOICE"

  if $USER_SCRIPTS_PATH/eink/paperlike-connected; then
    EINK_MONITOR=$($USER_SCRIPTS_PATH/eink/paperlike-input-name)
    EINK_DEFAULT_WALLPAPER="$HOME/dot/files/assets/wallpapers/white.jpg"

    swww img --outputs "$EINK_MONITOR" --transition-type none "$EINK_DEFAULT_WALLPAPER"
  fi

  ~/.local/bin/public/wallpaper/apply-colors-globally
}

CHOICE=$(ls $WALLPAPERS_PATH/* | shuf | xargs nsxiv -otb)

if [[ "$CHOICE" ]]; then
  apply-wallpaper $CHOICE
fi
