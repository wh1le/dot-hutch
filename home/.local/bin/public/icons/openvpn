#!/usr/bin/env python3
import gi

gi.require_version('AppIndicator3', '0.1')
import subprocess

from gi.repository import AppIndicator3, GLib, Gtk


def check_vpn():
    return subprocess.run(['pgrep', '-x', 'openvpn'], capture_output=True).returncode == 0

def update(indicator):
    if check_vpn():
        indicator.set_icon_full("network-vpn", "VPN Connected")
        indicator.set_status(AppIndicator3.IndicatorStatus.ACTIVE)
    else:
        indicator.set_status(AppIndicator3.IndicatorStatus.PASSIVE)
    return True

indicator = AppIndicator3.Indicator.new("openvpn", "network-vpn", AppIndicator3.IndicatorCategory.SYSTEM_SERVICES)

menu = Gtk.Menu()
quit_item = Gtk.MenuItem(label="Quit")
quit_item.connect("activate", Gtk.main_quit)
menu.append(quit_item)
menu.show_all()
indicator.set_menu(menu)

GLib.timeout_add_seconds(3, update, indicator)
update(indicator)
Gtk.main()
