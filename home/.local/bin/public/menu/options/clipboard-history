#!/usr/bin/env bash

set -euo pipefail

source "$LAUNCHER_SCRIPTS_PATH/helpers/fzf-with-options"

if pgrep -f 'kitty.*--class '"$KITTY_LAUNCHER_CLASS" >/dev/null; then
  hyprctl dispatch resizeactive 700 400
  hyprctl dispatch centerwindow
  kitty @ --to unix:/tmp/kitty-launcher set-font-size 10
fi

history_list=$(cliphist list || true)

[ -z "$history_list" ] && exit 0

choice=$(
  printf '%s\n' "$history_list" |
    fzf-with-options \
      --prompt="clipboard> " \
      --no-multi \
      --preview='echo {} | cut -f1 | xargs -I{} cliphist decode {}' \
      --preview-window=right:50%:wrap
)
# choice=$(
#   printf '%s\n' "$history_list" |
#     fzf-with-options \
#       --prompt="clipboard> " \
#       --no-multi
# )

# user cancelled
[ -z "${choice:-}" ] && exit 0

# first field is ID
choice_id=${choice%%$'\t'*}

# copy decoded entry back to clipboard
cliphist decode "$choice_id" | wl-copy

# if we are in kitty launcher, close it after selection
if pgrep -f 'kitty.*--class '"$KITTY_LAUNCHER_CLASS" >/dev/null; then
  kitty @ --to "unix:$KITTY_LAUNCHER_SOCKET_PATH" close-window || true
else
  notify-send "Clipboard" "Restored from history"
fi
