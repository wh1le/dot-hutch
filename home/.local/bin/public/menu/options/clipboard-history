#!/usr/bin/env bash

set -euo pipefail

: "${LAUNCHER_SCRIPTS_PATH:=$HOME/.local/bin/public/menu}"
: "${KITTY_LAUNCHER_CLASS:=launcher}"
: "${KITTY_LAUNCHER_SOCKET_PATH:=/tmp/kitty-launcher}"

source "$LAUNCHER_SCRIPTS_PATH/helpers/fzf-with-options"

history_list=$(cliphist list || true)

[ -z "$history_list" ] && exit 0

choice=$(
  printf '%s\n' "$history_list" |
    fzf-with-options \
      --prompt="clipboard> " \
      --no-multi
)

# user cancelled
[ -z "${choice:-}" ] && exit 0

# first field is ID
choice_id=${choice%%$'\t'*}

# copy decoded entry back to clipboard
cliphist decode "$choice_id" | wl-copy

# if we are in kitty launcher, close it after selection
if pgrep -f 'kitty.*--class '"$KITTY_LAUNCHER_CLASS" >/dev/null; then
  kitty @ --to "unix:$KITTY_LAUNCHER_SOCKET_PATH" close-window || true
else
  notify-send "Clipboard" "Restored from history"
fi
