#!/usr/bin/env bash

menu() {
  # args: prompt, then items...
  local prompt=$1
  shift
  local out key sel
  out=$(
    printf '%s\n' "$@" |
      fzf --prompt="$prompt" \
        --expect=ctrl-b,ctrl-c
  ) || return 1

  key=$(printf '%s\n' "$out" | sed -n '1p')
  sel=$(printf '%s\n' "$out" | sed -n '2p')

  printf '%s\n' "$key" "$sel"
}

main() {
  local state="root"
  local key sel out

  while true; do
    case "$state" in
    root)
      out=$(menu "Main > " \
        "programs" \
        "nix" \
        "pass" \
        "quit")
      ;;
    nix)
      out=$(menu "Main > nix > " \
        "Search packages" \
        "Search options" \
        "Rebuild" \
        "← Back")
      ;;
      # add other menus...
    esac

    key=$(printf '%s\n' "$out" | sed -n '1p')
    sel=$(printf '%s\n' "$out" | sed -n '2p')

    # ESC / ctrl-c / no selection
    [[ -z "$out" || "$key" == "ctrl-c" ]] && break

    case "$state:$key:$sel" in
    # hotkey Back from any submenu
    nix:ctrl-b:*) state="root" ;;

    # normal selections
    root::nix) state="nix" ;;
    root::programs) state="programs" ;;
    root::pass) state="pass" ;;
    root::quit) break ;;

    nix::"← Back") state="root" ;;
    nix::"Search packages") echo "do nix search" ;;
    nix::"Search options") echo "do nixos-options" ;;
    nix::Rebuild) echo "do rebuild" ;;
    esac
  done
}

main "$@"
